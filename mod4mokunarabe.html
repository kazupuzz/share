<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mod4目並べ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 追加のカスタムスタイル */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap');

        body {
            font-family: 'Noto Serif JP', serif;
        }

        .stone-shadow {
            box-shadow: 2px 3px 4px rgba(0, 0, 0, 0.4), inset -2px -2px 6px rgba(0,0,0,0.2);
        }

        .stone-black {
            background: radial-gradient(circle at 35% 35%, #666, #000);
            color: #fff;
            text-shadow: 0px 1px 2px rgba(0,0,0,0.8);
        }

        .stone-white {
            background: radial-gradient(circle at 35% 35%, #fff, #d4d4d4);
            color: #000;
            border: 1px solid #aaa;
        }

        .wood-texture {
            background-color: #DCB35C;
            box-shadow: inset 0 0 40px rgba(0,0,0,0.1);
            background-image: linear-gradient(45deg, rgba(255,255,255,0.05) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.05) 50%, rgba(255,255,255,0.05) 75%, transparent 75%, transparent);
            background-size: 40px 40px;
        }

        /* アニメーション */
        @keyframes zoomIn {
            from { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        .animate-zoom-in {
            animation: zoomIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes pulse-ring {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.5); opacity: 0; }
            100% { transform: scale(1); opacity: 0; }
        }
        .animate-ping-slow {
            animation: pulse-ring 2s cubic-bezier(0, 0, 0.2, 1) infinite;
        }

        /* モーダルアニメーション */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
    </style>
</head>
<body class="min-h-screen bg-[#f3f0e6] flex flex-col items-center py-8 selection:bg-stone-300 text-stone-800">

    <!-- ヘッダー -->
    <header class="mb-8 text-center px-4">
        <h1 class="text-4xl font-bold text-stone-900 mb-3 tracking-widest" style="text-shadow: 1px 1px 0px rgba(0,0,0,0.1)">
            mod4目並べ
        </h1>
        <p class="text-stone-700 text-sm tracking-wide">
            <span class="font-bold text-red-700 border-b border-red-700 pb-0.5 mx-1">同色の石4つ</span>
            の合計が
            <span class="font-bold mx-1">4の倍数</span>
            で勝利
        </p>
        <p class="text-stone-500 text-xs mt-1">
            (使用する石：1, 2, 3, 4)
        </p>
    </header>

    <!-- メインエリア -->
    <div class="flex flex-col lg:flex-row gap-12 items-center justify-center w-full max-w-6xl px-4">
        
        <!-- 左サイド: 黒プレイヤー情報 -->
        <div class="order-2 lg:order-1 flex-1 flex justify-end w-full lg:w-auto">
            <div id="player-black-panel" class="flex flex-col items-center p-6 rounded-xl transition-all duration-500 relative border border-transparent">
                <div id="player-black-title" class="font-bold mb-4 text-xl tracking-widest border-b-2 pb-1 border-transparent text-stone-500">
                    先手【黒】
                </div>
                
                <div class="flex items-end gap-4">
                    <!-- 現在の手 -->
                    <div class="flex flex-col items-center">
                        <span class="text-xs font-bold mb-2 text-stone-600 tracking-wider">次の一手</span>
                        <div id="black-next-1" class="stone-shadow stone-black w-14 h-14 rounded-full flex items-center justify-center text-2xl font-bold transition-all duration-300">
                            -
                        </div>
                    </div>
                    <!-- 次の手 -->
                    <div class="flex flex-col items-center opacity-80">
                        <span class="text-xs mb-1 text-stone-500">その次</span>
                        <div id="black-next-2" class="stone-shadow stone-black w-10 h-10 rounded-full flex items-center justify-center text-base font-bold">
                            -
                        </div>
                    </div>
                    <!-- 次の次の手 -->
                    <div class="flex flex-col items-center opacity-60">
                        <div id="black-next-3" class="stone-shadow stone-black w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold">
                            -
                        </div>
                    </div>
                </div>
                <!-- 手番インジケーター -->
                <div id="black-indicator" class="hidden absolute -top-2 -right-2 w-4 h-4 bg-red-500 rounded-full animate-ping-slow"></div>
            </div>
        </div>

        <!-- 中央: 盤面 -->
        <div class="order-1 lg:order-2 relative select-none p-1 rounded shadow-2xl bg-[#5d3a1a]">
            <!-- 木目背景 -->
            <div class="wood-texture p-6 relative rounded-sm">
                <!-- 盤面コンテナ -->
                <div id="board-container" class="relative" style="width: min(80vw, 440px); height: min(80vw, 440px);">
                    
                    <!-- グリッド線 (JSで生成) -->
                    <div id="grid-lines" class="absolute inset-0 pointer-events-none"></div>

                    <!-- 星 (Star Points) (JSで生成) -->
                    <div id="star-points" class="absolute inset-0 pointer-events-none"></div>

                    <!-- インタラクションレイヤー (石配置場所) (JSで生成) -->
                    <div id="stones-layer" class="absolute inset-0 z-10"></div>

                </div>
            </div>
        </div>

        <!-- 右サイド: 白プレイヤー情報 -->
        <div class="order-3 lg:order-3 flex-1 flex justify-start w-full lg:w-auto">
            <div id="player-white-panel" class="flex flex-col items-center p-6 rounded-xl transition-all duration-500 relative border border-transparent opacity-60 grayscale">
                <div id="player-white-title" class="font-bold mb-4 text-xl tracking-widest border-b-2 pb-1 border-transparent text-stone-500">
                    後手【白】
                </div>
                
                <div class="flex items-end gap-4">
                    <!-- 現在の手 -->
                    <div class="flex flex-col items-center">
                        <span class="text-xs font-bold mb-2 text-stone-600 tracking-wider">次の一手</span>
                        <div id="white-next-1" class="stone-shadow stone-white w-14 h-14 rounded-full flex items-center justify-center text-2xl font-bold transition-all duration-300">
                            -
                        </div>
                    </div>
                    <!-- 次の手 -->
                    <div class="flex flex-col items-center opacity-80">
                        <span class="text-xs mb-1 text-stone-500">その次</span>
                        <div id="white-next-2" class="stone-shadow stone-white w-10 h-10 rounded-full flex items-center justify-center text-base font-bold">
                            -
                        </div>
                    </div>
                    <!-- 次の次の手 -->
                    <div class="flex flex-col items-center opacity-60">
                        <div id="white-next-3" class="stone-shadow stone-white w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold">
                            -
                        </div>
                    </div>
                </div>
                 <!-- 手番インジケーター -->
                 <div id="white-indicator" class="hidden absolute -top-2 -right-2 w-4 h-4 bg-red-500 rounded-full animate-ping-slow"></div>
            </div>
        </div>
    </div>

    <!-- コントロール -->
    <div class="mt-12">
        <button id="reset-button" class="flex items-center gap-2 px-8 py-3 bg-stone-800 hover:bg-stone-700 text-[#eaddcf] rounded shadow-lg transition-colors font-bold tracking-wider">
            <!-- SVG Icon -->
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/>
                <path d="M3 3v9h9"/>
            </svg>
            盤面を改める
        </button>
    </div>

    <!-- 勝利モーダル -->
    <div id="winner-modal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center backdrop-blur-sm animate-fade-in">
        <div class="bg-[#fcfaf5] p-10 rounded-sm shadow-2xl text-center max-w-sm mx-4 border border-stone-300 relative">
            <div class="absolute -top-3 -left-3 w-6 h-6 border-t-2 border-l-2 border-stone-400"></div>
            <div class="absolute -bottom-3 -right-3 w-6 h-6 border-b-2 border-r-2 border-stone-400"></div>
            
            <h2 class="text-xl text-stone-500 mb-4 tracking-widest font-bold">勝負あり</h2>
            <div id="winner-text" class="text-5xl mb-8 font-bold text-stone-900 border-b-2 border-stone-200 pb-6">
                <!-- 勝者名 -->
            </div>
            <p class="text-stone-600 mb-8 text-sm">
                見事な打ち回しでした。
            </p>
            <button id="modal-reset-button" class="w-full py-3 bg-stone-800 hover:bg-stone-700 text-[#eaddcf] font-bold tracking-widest transition-colors shadow-md">
                もう一局
            </button>
        </div>
    </div>

    <script>
        // --- 定数と型定義の代わり ---
        const BOARD_SIZE = 11;
        const PLAYER_BLACK = 'black';
        const PLAYER_WHITE = 'white';
        const MOD_NUM = 4;
        const WIN_COUNT = 4;

        // 星の位置
        const STAR_POINTS = [
            { r: 2, c: 2 }, { r: 2, c: 8 },
            { r: 8, c: 2 }, { r: 8, c: 8 },
            { r: 5, c: 5 }
        ];

        // --- 状態管理 ---
        let board = [];
        let turn = PLAYER_BLACK;
        let winner = null;
        let winningLine = [];
        let blackQueue = [];
        let whiteQueue = [];

        // --- ヘルパー関数 ---
        const generateValue = () => Math.floor(Math.random() * MOD_NUM) + 1;
        const generateQueue = (length = 100) => Array.from({ length }, generateValue);

        // --- ゲームロジック ---

        function initializeGame() {
            // 盤面初期化
            board = Array(BOARD_SIZE).fill(null).map(() => Array(BOARD_SIZE).fill(null));
            turn = PLAYER_BLACK;
            winner = null;
            winningLine = [];
            blackQueue = generateQueue();
            whiteQueue = generateQueue();

            renderGame();
        }

        function checkWin(r, c, currentBoard, player) {
            const directions = [
                [0, 1],   // 横
                [1, 0],   // 縦
                [1, 1],   // 斜め (左上から右下)
                [1, -1]   // 斜め (右上から左下)
            ];

            for (const [dr, dc] of directions) {
                for (let k = 0; k > -WIN_COUNT; k--) {
                    const cells = [];
                    let sum = 0;
                    let valid = true;

                    for (let i = 0; i < WIN_COUNT; i++) {
                        const nr = r + (k + i) * dr;
                        const nc = c + (k + i) * dc;

                        if (nr < 0 || nr >= BOARD_SIZE || nc < 0 || nc >= BOARD_SIZE) {
                            valid = false;
                            break;
                        }

                        const stone = currentBoard[nr][nc];
                        if (!stone || stone.player !== player) {
                            valid = false;
                            break;
                        }

                        cells.push({ r: nr, c: nc });
                        sum += stone.value;
                    }

                    if (valid && sum % MOD_NUM === 0) {
                        winner = player;
                        winningLine = cells;
                        return true;
                    }
                }
            }
            return false;
        }

        function handleCellClick(r, c) {
            if (winner || board[r][c]) return;

            const currentQueue = turn === PLAYER_BLACK ? blackQueue : whiteQueue;
            const valueToPlace = currentQueue[0];

            // 盤面更新
            board[r][c] = { player: turn, value: valueToPlace };

            const isWin = checkWin(r, c, board, turn);

            if (!isWin) {
                // キュー更新
                if (turn === PLAYER_BLACK) {
                    blackQueue.shift();
                    blackQueue.push(generateValue());
                    turn = PLAYER_WHITE;
                } else {
                    whiteQueue.shift();
                    whiteQueue.push(generateValue());
                    turn = PLAYER_BLACK;
                }
            }

            renderGame();
        }

        // --- レンダリング ---

        function initBoardGrid() {
            const gridLinesEl = document.getElementById('grid-lines');
            const starPointsEl = document.getElementById('star-points');
            
            // グリッド線生成
            let linesHtml = '';
            // 横線
            for (let i = 0; i < BOARD_SIZE; i++) {
                const top = (i / (BOARD_SIZE - 1)) * 100;
                linesHtml += `<div class="absolute bg-stone-900 w-full h-[1px] transform -translate-y-1/2" style="top: ${top}%"></div>`;
            }
            // 縦線
            for (let i = 0; i < BOARD_SIZE; i++) {
                const left = (i / (BOARD_SIZE - 1)) * 100;
                linesHtml += `<div class="absolute bg-stone-900 h-full w-[1px] transform -translate-x-1/2" style="left: ${left}%"></div>`;
            }
            gridLinesEl.innerHTML = linesHtml;

            // 星生成
            let starsHtml = '';
            STAR_POINTS.forEach(p => {
                const top = (p.r / (BOARD_SIZE - 1)) * 100;
                const left = (p.c / (BOARD_SIZE - 1)) * 100;
                starsHtml += `<div class="absolute w-2 h-2 bg-stone-900 rounded-full transform -translate-x-1/2 -translate-y-1/2 shadow-sm" style="top: ${top}%; left: ${left}%"></div>`;
            });
            starPointsEl.innerHTML = starsHtml;
        }

        function renderGame() {
            renderPlayerPanels();
            renderStones();
            renderModal();
        }

        function renderPlayerPanels() {
            const updatePanel = (prefix, player, queue) => {
                const isCurrent = (turn === player) && !winner;
                const panel = document.getElementById(`player-${prefix}-panel`);
                const title = document.getElementById(`player-${prefix}-title`);
                const indicator = document.getElementById(`${prefix}-indicator`);
                
                // パネルのアクティブ状態
                if (isCurrent) {
                    panel.className = "flex flex-col items-center p-6 rounded-xl transition-all duration-500 relative bg-white/60 shadow-xl scale-105 border-yellow-600/30 border";
                    title.className = "font-bold mb-4 text-xl tracking-widest border-b-2 pb-1 border-yellow-600 text-stone-900";
                    indicator.classList.remove('hidden');
                } else {
                    panel.className = "flex flex-col items-center p-6 rounded-xl transition-all duration-500 relative border border-transparent opacity-60 grayscale";
                    title.className = "font-bold mb-4 text-xl tracking-widest border-b-2 pb-1 border-transparent text-stone-500";
                    indicator.classList.add('hidden');
                }

                // 数字更新
                for(let i=1; i<=3; i++) {
                    const el = document.getElementById(`${prefix}-next-${i}`);
                    el.textContent = queue[i-1];
                }
            };

            updatePanel('black', PLAYER_BLACK, blackQueue);
            updatePanel('white', PLAYER_WHITE, whiteQueue);
        }

        function renderStones() {
            const container = document.getElementById('stones-layer');
            let html = '';

            for (let r = 0; r < BOARD_SIZE; r++) {
                for (let c = 0; c < BOARD_SIZE; c++) {
                    const left = (c / (BOARD_SIZE - 1)) * 100;
                    const top = (r / (BOARD_SIZE - 1)) * 100;
                    const stone = board[r][c];
                    
                    // クリック領域の生成
                    let innerContent = '';
                    
                    if (stone) {
                        const isWinning = winningLine.some(cell => cell.r === r && cell.c === c);
                        const stoneClass = stone.player === PLAYER_BLACK ? 'stone-black' : 'stone-white';
                        const ringClass = isWinning ? 'ring-4 ring-red-500/70 z-20 scale-105' : '';
                        
                        innerContent = `
                            <div class="stone-shadow ${stoneClass} w-[90%] h-[90%] rounded-full flex items-center justify-center text-sm md:text-lg font-bold animate-zoom-in ${ringClass}"
                                 style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                                ${stone.value}
                            </div>
                        `;
                    } else if (!winner) {
                        // ホバーエフェクト（透明な石）
                        // 擬似要素はインラインスタイルで扱いにくいため、要素として追加
                        const hoverColor = turn === PLAYER_BLACK ? '#000' : '#fff';
                        innerContent = `
                            <div class="w-[85%] h-[85%] rounded-full opacity-0 hover:opacity-40 transition-opacity pointer-events-none"
                                 style="background: ${hoverColor}; transform: scale(0.8);">
                            </div>
                        `;
                    }

                    // 石があってもなくてもクリックイベントをハンドルできるようにする
                    // onclick属性に直接関数を埋め込む
                    html += `
                        <div onclick="handleCellClick(${r}, ${c})" 
                             class="absolute flex items-center justify-center cursor-pointer"
                             style="left: ${left}%; top: ${top}%; width: 9.5%; height: 9.5%; transform: translate(-50%, -50%);">
                             <div class="absolute inset-0 rounded-full hover:bg-black/5 transition-colors duration-200"></div>
                             ${innerContent}
                        </div>
                    `;
                }
            }
            container.innerHTML = html;
        }

        function renderModal() {
            const modal = document.getElementById('winner-modal');
            const winnerText = document.getElementById('winner-text');
            
            if (winner) {
                modal.classList.remove('hidden');
                winnerText.textContent = (winner === PLAYER_BLACK ? '黒' : '白') + 'の勝ち';
            } else {
                modal.classList.add('hidden');
            }
        }

        // --- イベントリスナー設定 ---
        document.getElementById('reset-button').addEventListener('click', initializeGame);
        document.getElementById('modal-reset-button').addEventListener('click', initializeGame);

        // --- 初期化実行 ---
        initBoardGrid(); // 静的な盤面の描画
        initializeGame(); // ゲームステート初期化

    </script>
</body>
</html>